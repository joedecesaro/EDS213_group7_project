---
title: "Retrieve Data using an API"
author: "Felicia Cruz"
date: "10/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(metajam)
library(lubridate)

```
We are using `metajam` to download HAB data for the CA coast from DataOne. We wil specifically filter for locations at the Scripps Pier in La Jolla.

"California Harmful Algal bloom Monitoring and ALert Program Data"

https://search.dataone.org/view/https%3A%2F%2Fpasta.lternet.edu%2Fpackage%2Fmetadata%2Feml%2Fedi%2F988%2F4#https%3A%2F%2Fpasta.lternet.edu%2Fpackage%2Fdata%2Feml%2Fedi%2F988%2F4%2F4119639092e62c55ea8be348e4d9260d

https://cran.r-project.org/web/packages/rnoaa/rnoaa.pdf

```{r}
# set file path
path <- here()

```


## Data download: Event, Occurrence, and Extended Measurement Data.
 - Only run if data not already downloaded locally
 - Or alternatively, delete three "data pasta" folders and run all.
```{r, eval=FALSE}

# Event Data Download
event_data_url <- "https://cn.dataone.org/cn/v2/resolve/https%3A%2F%2Fpasta.lternet.edu%2Fpackage%2Fdata%2Feml%2Fedi%2F988%2F4%2F4119639092e62c55ea8be348e4d9260d"
event_data <- download_d1_data(event_data_url, path)


# Occurrence Data Download
occ_data_url <- "https://cn.dataone.org/cn/v2/resolve/https%3A%2F%2Fpasta.lternet.edu%2Fpackage%2Fdata%2Feml%2Fedi%2F988%2F4%2F7ad56af78ac5f73d81f5e80293f1d6c9"
occ_data <- download_d1_data(occ_data_url, path)


# Extended Measurement Download
ext_data_url <- "https://cn.dataone.org/cn/v2/resolve/https%3A%2F%2Fpasta.lternet.edu%2Fpackage%2Fdata%2Feml%2Fedi%2F988%2F4%2Ff616903aa9a2592cb3082cb3b9525270"
ext_data <- download_d1_data(ext_data_url, path)
```

## 
```{r}

# returns a list of all of the data in the folder 
all_event_data <- metajam::read_d1_files(here("https_pasta.lternet.edu_package_metadata_eml_edi_988_4__event__csv"))

all_occ_data <- read_d1_files(here("https_pasta.lternet.edu_package_metadata_eml_edi_988_4__occurrence__csv"))

all_ext_data <- read_d1_files(here("https_pasta.lternet.edu_package_metadata_eml_edi_988_4__extendedmeasurementorfact__csv"))


```


## Event data filtering
- By looking at the metadata, this includes location and geometric info 
```{r, error=TRUE}

# view all event data
View(all_event_data$data)

# filter for ScrippsPier
scripps <- all_event_data$data %>% 
  filter(locationID == "HABs-ScrippsPier") %>% 
  data.frame()

# View used to double check creation of dataframe. Not necessary for workflow
# view(scripps)

occ <- all_occ_data$data
ext <- all_ext_data$data

```

# join different data sets together.  
```{r}
# joins Scripps event data and occurrence data
scripps_1 <- left_join(scripps, occ, by = "id")

# joins Scripps event data/occurrence data with extended measurement data
scripps_combined <- left_join(scripps_1, ext, by = "id")
```

```{r}

# Remove columns unrelated to our anticipated analysis on HABs
scripps_combined <- scripps_combined %>% 
  
  # select columns of interest
  select(-c(eventID, locationID, eventRemarks, basisOfRecord, decimalLatitude, decimalLongitude,minimumDepthInMeters, maximumDepthInMeters,coordinateUncertaintyInMeters, measurementID, measurementTypeID, measurementUnitID)) %>% 
  
  # remove NA values
  drop_na() %>% 
  
  # create year column
  mutate(year = lubridate::year(eventDate))
  
```

```{r}

unique(scripps_combined$measurementType)

# View used to double check creation of dataframe. Not necessary for workflow
# view(scripps_combined)
```

## HAB Analysis
 - Create time series of total HAB events per year
 - 


```{r}
scripps_nutrients <- scripps_combined %>% 
  group_by(year, measurementType) %>% 
  summarize(Measurement_sum = sum(measurementValue))

scripps_nutrients

scripps_quantity <- scripps_combined %>% 
  group_by(year, scientificName) %>% 
  summarize(Organism_sum = sum(organismQuantity)) %>% 
  mutate(year = as.factor(year))

scripps_quantity
  
```



```{r}

plot <- ggplot(data = scripps_quantity, aes(x = year, y = Organism_sum, color = scientificName)) +
  geom_line() +
  labs(title = "Scripps Pier Algae Counts from 2011 to 2020",
       x = "Year",
       y = "Organism Counts")
plot
```
```{r}

## Units are different for constituents
plot <- ggplot(data = scripps_nutrients, aes(x = year, y = Measurement_sum, color = measurementType)) +
  geom_line() +
  labs(title = "Scripps Pier Yearly Measurement Totals")
plot
```



```{r}
plot2 <- ggplot(data = scripps_combined, aes(x = eventDate, y = organismQuantity)) +
  geom_point(aes(color = scientificName)) +
  ylim(0,25000)
plot2
```


## Occurrence Data
- From looking at the data and metadata, this includes organism information 
```{r, error = TRUE}

View(all_occ_data$attribute_metadata)
view(all_occ_data$data)
```

## Extended Measurement Data 
- From the data and metadata, this contains information about measurement type, value, etc.  
```{r, error = TRUE}

View(all_ext_data$attribute_metadata)
View(all_ext_data$data)
```

